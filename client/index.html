<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="./output.css" rel="stylesheet" />
    <title>Chat Web Socket</title>

    <script type="module">
      import { io } from "https://cdn.socket.io/4.8.1/socket.io.esm.min.js";

      const getUsername = async () => {
        const username = localStorage.getItem("username");
        if (username) return username;

        try {
          const res = await fetch("https://randomuser.me/api/");
          const data = await res.json();
          const username = data.results[0].name.first;
          localStorage.setItem("username", username);
          return username;
        } catch (error) {
          console.error("Error fetching username:", error);
        }
      };

      const socket = io({
        auth: {
          serverOffset: 0,
          username: await getUsername(),
        },
      });

      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const message = document.getElementById("message");
      const chat = document.getElementById("chat");

      socket.on("chat message", (msg, serverOffset, username) => {
        const item = document.createElement("li");
        item.textContent = `${username}: ${msg}`;

        item.classList.add(
          "p-2",
          "my-1",
          // "bg-gray-800",
          "rounded"
          // "text-white"
        );
        if (username === socket.auth.username) {
          item.classList.add("bg-green-400", "text-black", "self-end");
        } else {
          item.classList.add("bg-gray-800", "text-white", "self-start");
        }
        message.appendChild(item);

        chat.scrollTo({
          top: chat.scrollHeight,
          behavior: "smooth",
        });

        socket.auth.serverOffset = serverOffset;
      });

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = input.value;
        socket.emit("chat message", message);
        input.value = "";
      });
    </script>
  </head>

  <body class="flex flex-col items-center h-screen bg-gray-700">
    <h1 class="text-3xl font-bold text-white">Chat Web Socket</h1>

    <section
      id="chat"
      class="flex flex-col flex-1 border border-white justify-baseline rounded-xl w-fit overflow-y-scroll"
    >
      <ul id="message" class="flex-1 p-2 bg-gray-900 rounded-t-xl"></ul>
      <form action="" id="form" class="flex flex-row items-end">
        <input
          type="text"
          name="message"
          id="input"
          placeholder="Type your message here..."
          class="p-2 text-white bg-gray-800 rounded-bl-xl w-80"
        />
        <button type="submit" class="p-2 text-white bg-amber-500 rounded-br-xl">
          Send
        </button>
      </form>
    </section>
  </body>
</html>
